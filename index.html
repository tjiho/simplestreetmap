<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>OpenMapTiles OSM Bright style</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://maps.ppsfleet.navy/mapbox/mapbox-gl-unminified.js'></script>
    <link href='https://maps.ppsfleet.navy/mapbox/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://underscorejs.org/underscore-min.js"></script>
    <link href='/static/css/style.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>
    <div id='map'></div>
    <div id="search-container">
        <label class="search-label" for="search-input">
            <img src="/static/images/helium/search.svg" class="search-label__icon"/>
            <input type="search" placeholder="search..." id="search-input" class="search-label__input"/>
        </label>
        <div id="search-results">
        </div>
    </div>
    <script>
        var currentSearchMarker = null

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'https://maps.ppsfleet.navy/tileserver-data/osm-bright-gl-style/style-cdn.json',
            center: [1.4436, 43.6042],
            zoom: 12
        });

        function clickOnResult(result) {
          if (currentSearchMarker)
            currentSearchMarker.parentNode.removeChild(currentSearchMarker);
          currentSearchMarker = document.createElement('div');
          currentSearchMarker.className = 'marker';
          new mapboxgl.Marker(currentSearchMarker)
              .setLngLat([result.lon,result.lat])
              .addTo(map);

          map.flyTo({center: [result.lon,result.lat], zoom: 13});


        }

        function search(query) {
          axios.get('https://nominatim.openstreetmap.org/search?format=json&q='+query)
          .then(function (response) {
            cleanSearchResults()
            response.data.slice(0, 5).forEach( (res) => displaySearchResult(res))
            console.log(response);
          })
          .catch(function (error) {
            // handle error
            console.log(error);
          })
        }
/*
        function addMarker(lon,lat,id) {
          map.loadImage('/helium/pin.svg.png', function(error, image) {
            if (error) throw error;
            map.addImage('marker', image);
            map.addLayer({
             "id": id,
             "type": "symbol",
             "source": {
                 "type": "geojson",
                 "data": {
                     "type": "FeatureCollection",
                     "features": [
                         {
                             "type": "Feature",
                             "properties": {},
                             "geometry": {
                                 "type": "Point",
                                 "coordinates": [
                                     lon,
                                     lat

                                 ]
                             }
                         },
                     ]
                 }
             },
             "layout": {
                 "icon-image": "marker",
                 "icon-size": 0.25
             }
           });
         })
           console.log("add marker")
        }*/
        //marker_11

        var lazySearch = _.debounce(search, 300);

        function displaySearchResult(result) {
          let domResult = document.createElement("div")
          domResult.classList.add("search-results__result")
          domResult.innerText = result.display_name
          domResult.addEventListener("click", (e) => {
            clickOnResult(result)
          })
          document.getElementById("search-results").appendChild(domResult)
        }

        function cleanSearchResults() {
          document.getElementById("search-results").innerHTML = ""
        }

        document.getElementById("search-input").addEventListener("input", (e) => {
          lazySearch(e.target.value)
        });

        //search("6 impasse anjou")
    </script>
</body>
</html>
